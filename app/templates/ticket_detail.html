{% extends "base.html" %}

{% block title %}جزئیات تیکت #{{ ticket.id }}{% endblock %}

{% block content %}
<div class="card mb-4" data-aos="fade-up">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">موضوع: {{ ticket.title }}</h4>
        <span class="status-badge status-{{ ticket.status.name.replace('_', '-').lower() }}">{{ ticket.status.value }}</span>
    </div>
    <div class="card-body">
        <p class="card-text">{{ ticket.content }}</p>
        <hr>
        <p><strong>دسته‌بندی:</strong> {{ ticket.category.name if ticket.category else '-' }}</p>
        <div class="mt-3">
            {% if (ticket.created_by == current_user or current_user.role in ['admin', 'supervisor']) and ticket.status.name != 'DELETED' %}
                <a href="{{ url_for('edit_ticket', ticket_id=ticket.id) }}" class="btn btn-sm btn-warning">ویرایش</a>
            {% endif %}
            {% if current_user.role in ['admin', 'supervisor'] and ticket.status.name != 'DELETED' %}
                <form action="{{ url_for('delete_ticket', ticket_id=ticket.id) }}" method="POST" class="d-inline" onsubmit="return confirm('آیا از حذف این تیکت مطمئن هستید؟');">
                    <button type="submit" class="btn btn-sm btn-danger">حذف</button>
                </form>
            {% endif %}
        </div>
    </div>
    <div class="card-footer text-muted">
        ایجاد شده توسط: {{ ticket.created_by.username }} در تاریخ {{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}
    </div>
</div>

<h3 class="mt-5 mb-3" data-aos="fade-up">پاسخ‌ها</h3>
{% for reply in replies %}
<div class="card mb-3" data-aos="fade-up">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-bold">{{ reply.user.username }}</span>
        <span class="text-muted">{{ reply.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
    </div>
    <div class="card-body">
        <p class="card-text">{{ reply.content }}</p>
    </div>
</div>
{% else %}
<div class="alert alert-info" data-aos="fade-up">هنوز پاسخی برای این تیکت ثبت نشده است.</div>
{% endfor %}

<hr>

{% if ticket.status.name != 'DELETED' %}
<div class="card mb-4" data-aos="fade-up">
    <div class="card-body">
        <h5 class="card-title">ثبت پاسخ جدید</h5>
        <form method="POST">
            <div class="mb-3">
                <textarea class="form-control" name="reply_content" rows="4" required placeholder="پاسخ خود را اینجا بنویسید..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">ارسال پاسخ</button>
        </form>
    </div>
</div>
{% endif %}

<h3 class="mb-3" data-aos="fade-up">تاریخچه تیکت</h3>
<div class="timeline" data-aos="fade-up">
{% for log in ticket.logs|reverse %}
    <div class="timeline-item">
        <div class="log-meta">
            <span class="fw-bold">{{ log.user.username }}</span>
            در تاریخ {{ log.created_at.strftime('%Y-%m-%d %H:%M') }}
            یک رویداد ثبت کرد:
        </div>
        <div class="log-details">{{ log.action }} {% if log.details %} ({{ log.details }}) {% endif %}</div>
    </div>
{% else %}
    <div class="timeline-item">
        <div class="log-details">تاریخچه‌ای برای این تیکت وجود ندارد.</div>
    </div>
{% endfor %}
</div>
{% endblock %}
